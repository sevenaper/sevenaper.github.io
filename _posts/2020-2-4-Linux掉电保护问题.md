---
title: Linux掉电保护问题
key: 20200204
tags: Linux
---

## 掉电导致write()的数据丢失破解法

延迟写（delayed write）: 传统的UNIX实现在内核中设有缓冲区高速缓存或页面高速缓存，大多数磁盘I/O都通过缓冲进行。 当将数据写入文件时，内核通常先将该数据复制到其中一个缓冲区中，如果该缓冲区尚未写满，则 并不将其排入输出队列，而是等待其写满或者当内核需要重用该缓冲区以便存放其他磁盘块数据时， 再将该缓冲排入到输出队列，然后待其到达队首时，才进行实际的I/O操作。这种输出方式就被称为延迟写。

#### 直接I/O：直接访问物理磁盘：

O_DIRECT：绕过内核缓冲区。记得要用posix_memalign管理内存对齐

#### open文件时用O_SYNC选项：

同步选项【把数据直接同步到磁盘】,只针对write函数有效，使每次write()操作等待物理I/O操作的完成；具体说，就是将写入内核缓冲区的数据立即写入磁盘，将掉电等问题造成的损失减到最小；每次写磁盘数据，务必要大块大块写，一般都512-4k 4k的写；不要每次只写几个字节，否则速度过慢；

#### 缓存同步：尽量保证缓存数据和写道磁盘上的数据一致；

1. sync(void)：将所有修改过的块缓冲区排入写队列；然后返回，并不等待实际写磁盘操作结束，数据是否写入磁盘并没有保证；

2. fsync(int fd)：将fd对应的文件的块缓冲区立即写入磁盘，并等待实际写磁盘操作结束返回；

3. fdatasync(int fd)：类似于fsync，但只影响文件的数据部分。而fsync不一样，fsync除数据外，还会同步更新文件属性；多次write,每次write建议都4k，然后调用一次fsync()，这才是用fsync()的正确用法

> 1、如果是对所有的缓冲区发出写硬盘的命令，应该使用sync函数，但应该注意该函数仅仅只是把该命令放入队列就返回了，在编程时需要注意。
>
> 2、如果是要把一个已经打开的文件所做的修改提交到硬盘，应调用fsync函数，该函数会在数据实际写入硬盘后才返回，因此是最安全最可靠的方式。
>
> 3、如果是针对一个已经打开的文件流操作，则应该首先调用fsync函数把修改同步到内核缓冲区，然后再调用fsync把修改真正的同步到硬盘。


